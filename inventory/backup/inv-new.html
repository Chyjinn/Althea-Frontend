<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css" type="text/css" />
	<script src="https://kit.fontawesome.com/2e18c099ce.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/0.9.0/progressbar.min.js"></script>
</head>
<body>
<div class="content">

      <div class="inventory">
	  <div class="navigation">
		<image src="css/logo.png" class="logo">
		<input type="text" class="amount">
		<i id="wallet-button" class="fa-solid fa-wallet navbuttons"></i>
		<i id="clothes-button" class="fa-solid fa-shirt navbuttons"></i>
		<i id="bag-button" class="fa-solid fa-briefcase navbuttons"></i>
		</div>
		
        <div id="inv-0" class="slotSpace">
          <div id="0;0" class="slot"></div>
          <div id="0;1" class="slot"></div>
          <div id="0;2" class="slot"></div>
          <div id="0;3" class="slot"></div>
          <div id="0;4" class="slot"></div>
          <div id="0;5" class="slot"></div>
          <div id="0;6" class="slot"></div>
          <div id="0;7" class="slot"></div>
          <div id="0;8" class="slot"></div>
          <div id="0;9" class="slot"></div>
          <div id="0;10" class="slot"></div>
          <div id="0;11" class="slot"></div>
          <div id="0;12" class="slot"></div>
          <div id="0;13" class="slot"></div>
          <div id="0;14" class="slot"></div>
          <div id="0;15" class="slot"></div>
          <div id="0;16" class="slot"></div>
          <div id="0;17" class="slot"></div>
          <div id="0;18" class="slot"></div>
          <div id="0;19" class="slot"></div>
          <div id="0;20" class="slot"></div>
          <div id="0;21" class="slot"></div>
          <div id="0;22" class="slot"></div>
          <div id="0;23" class="slot"></div>
		  <div id="0;24" class="slot"></div>
        </div>
      </div>
	  
	  <div class="wallet slotSpace">
		  <div id="1;0" class="slot"></div>
          <div id="1;1" class="slot"></div>
          <div id="1;2" class="slot"></div>
          <div id="1;3" class="slot"></div>
          <div id="1;4" class="slot"></div>
          <div id="1;5" class="slot"></div>
          <div id="1;6" class="slot"></div>
          <div id="1;7" class="slot"></div>
	  </div>
	  
	  
	  <div id="tooltip">Valami tooltip.</div>
    </div>
	
    </body>
	<script>
let amount = 0;
let current_slot = null;
let status_click = false;
let current_itemId = null;
let current_itemType = null;
let current_itemValue = null;
const weightbar = document.getElementById('weightbar');
const tooltip = document.getElementById('tooltip');


const sectioninv = document.querySelector('#inv-0');
const sectionkeys = document.querySelector('#inv-1');
const sectionclothes=  document.querySelector('#inv-2');

	function displayToolTip(text){
		tooltip.innerHTML = text;
		tooltip.style.display = 'block';
		document.addEventListener('mousemove', moveToolTip);
	}
	
	function displayItemInfo(event){
	let displayinfoitem = event.target;
	let name = displayinfoitem.itemname+'<br/>'+ displayinfoitem.itemdescription;
		tooltip.innerHTML = name;
		tooltip.style.display = 'block';
		document.addEventListener('mousemove', moveToolTip);
	}
	
	
	function hideToolTip(){
		tooltip.style.display = 'none';
		document.removeEventListener('mousemove', moveToolTip);
	}


  function moveToolTip(event) {
    let x = event.clientX;
    let y = event.clientY;
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
  }

	let pages = document.querySelectorAll('.navbuttons');
	
	pages.forEach((item) => {
	  item.addEventListener('click', switchPage);
	  item.setAttribute('draggable', false);
	});
	
	function switchPage(event){
	console.log(event.target.id);
	switch(event.target.id) {
	  case 'section0'://fő ablak
		sectioninv.style.display = 'flex';
		sectionkeys.style.display = 'none';
		sectionclothes.style.display = 'none';
		console.log('vmi');
		break;
	  case 'section1'://kulcsok
		sectioninv.style.display = 'none';
		sectionkeys.style.display = 'flex';
		sectionclothes.style.display = 'none';
		break;
		case 'section2'://ruhák
		sectioninv.style.display = 'none';
		sectionkeys.style.display = 'none';
		sectionclothes.style.display = 'flex';
		break;
	  default:
    // code block
		}
	  pages.forEach((item) => {
	  item.style.color = 'white';
	  });
	  event.target.style.color = 'orange';

	}

let items = null;
const amountTextBox = document.querySelector('.amount');




function refreshInputValue(e){
if(e.target.value == '')
{
amount = 1000000;
}
else if(e.target.value >= 0){
amount = e.target.value;
}
else
{
amount = 1;
}
console.log(amount);
};

amountTextBox.addEventListener('input', refreshInputValue);


function moveItem(event) {
if(this.isactive == false && event.button == 0)
	{
	if(amount == 0 || amount > parseInt(this.lastElementChild.innerHTML)){//ha nem adtunk meg mennyiséget, vagy nagyobb a mennyiség mint ahány item van

	  event.preventDefault();
	  const item = this;
	  let waitItem = this;
	  let ghostItem = item.cloneNode(true);
	  ghostItem.setAttribute('class', 'ghostItem');
	  item.classList.add('invisible');
	  
	  let shiftX = ghostItem.getBoundingClientRect().left + 20;
	  let shiftY = ghostItem.getBoundingClientRect().top + 20;

	  ghostItem.style.position = 'absolute';
	  ghostItem.style.zIndex = 1000;
	  document.body.append(ghostItem);

	  ghostItem.onmouseup = function (event) {
		if (current_itemId && current_itemId != item.parentNode.id) {
		  let area = document.getElementById(current_itemId);
		  let free_space = !!!area.firstElementChild;

		  if (free_space) {
		  	let parts = item.parentNode.id.split(";");//a slot ID-je kell nekünk majd és átküldeni a section/slot-ot a szervernek hogy szeretnénk használni
			let section = parts[0];
			let startslot = parts[1]
			area.append(item);
			let parts2 = item.parentNode.id.split(";");
			let endslot = parts2[1];
	//parts[0] section
	//parts[1] slot
	//mp.trigger("client:MoveItemInInventoryToServer", parseInt(section),parseInt(startslot),parseInt(endslot) );
	console.log('itemmove-1');//sima item move szabad slotra
	
		  } else if (current_itemType == item.id) {
			let destiny = area.firstElementChild.lastElementChild.innerHTML;
			let origin = item.lastElementChild.innerHTML;
			let total = parseInt(destiny) + parseInt(origin);
			area.firstElementChild.lastElementChild.innerHTML = total;
			item.remove();
			console.log('itemmove-2');//ugyanolyan itemek, egybehúzás
		  } else {
			item.parentNode.append(area.firstElementChild);
			area.append(item);
			console.log('itemmove-3');//két item megcserélése ha ráhúzzuk a másikra
		  }
		}
		item && item.classList.remove('invisible');
		ghostItem.remove();
		status_click = false;
	  };

	  status_click = !status_click;

	  if (status_click) {
		moveAt(event.pageX, event.pageY);
	  }

	  function moveAt(pageX, pageY) {
		ghostItem.style.left = pageX - shiftX + 'px';
		ghostItem.style.top = pageY - shiftY + 'px';
	  }

	  function onMouseMove(event) {
		if (status_click) {
		  moveAt(event.pageX, event.pageY);
		}
		ghostItem.hidden = true;
		let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
		
		ghostItem.hidden = false;
		
		if (!elemBelow) return;
		let droppableBelow = elemBelow.closest('.slot');
		
		if (current_slot != droppableBelow) {
		  if (current_slot) {
			leaveDroppable(current_slot);
		  }
		  current_slot = droppableBelow;
		  if (current_slot) {
			enterDroppable(current_slot);
		  }
		}
	  }

	  document.addEventListener('mousemove', onMouseMove);
	  
	  }
	  
	  else if(parseInt(this.lastElementChild.innerHTML) >= parseInt(amount)){//kevesebb itemet szeretnénk mozgatni mint összesen van, szóval ketté szeretnénk válogatni
	   event.preventDefault();
	  const item = this;
	  let waitItem = this;
	  let ghostItem = item.cloneNode(true);
	  ghostItem.setAttribute('class', 'ghostItem');
	  ghostItem.lastElementChild.innerHTML = amount;
	  
	  //ezt ki kell venni, helyette átírni a számát annyira amennyi van
	  //ghostitem-nek meg az amount legyen a száma

	  //item.classList.add('invisible');

	  let shiftX = ghostItem.getBoundingClientRect().left + 20;
	  let shiftY = ghostItem.getBoundingClientRect().top + 20;

	  ghostItem.style.position = 'absolute';
	  ghostItem.style.zIndex = 1000;
	  document.body.append(ghostItem);

	  ghostItem.onmouseup = function (event) {
		if (current_itemId && current_itemId != item.parentNode.id) {//nem a jelenlegi itemre húzzuk vissza
		  let area = document.getElementById(current_itemId);
		  let free_space = !!!area.firstElementChild;
		  if (free_space) {//szabad a hely
			let newItem = item.cloneNode(true);
			newItem.addEventListener('mousedown', moveItem);
			newItem.setAttribute('draggable', false);
			newItem.lastElementChild.innerHTML = amount;
			if (parseInt(item.lastElementChild.innerHTML) <= amount) {
			  ghostItem.remove();
			  status_click = !status_click;
			  item.remove();
			  console.log('itemmove-5');//egészet húzzuk odébb, nem darabot
			} else {
			  item.lastElementChild.innerHTML =
				parseInt(item.lastElementChild.innerHTML - amount);
			  ghostItem.lastElementChild.innerHTML =
				parseInt(ghostItem.lastElementChild.innerHTML);
				console.log('itemmove-6');//csak egy részét húzzuk odébb, 2 item-re bontjuk a nagyobb mennyiséget
			}
			newItem.lastElementChild.innerHTML = amount;
			area.append(newItem);
			newItem.classList.remove('invisible');
		    newItem.addEventListener('mousedown', moveItem);
	  newItem.addEventListener('contextmenu', moveItem);
	  newItem.setAttribute('draggable', false);
	  newItem.isactive = false;
	    newItem.oncontextmenu = function (event) {
    event.preventDefault();
    let parts = item.parentNode.id.split(";");//a slot ID-je kell nekünk majd és átküldeni a section/slot-ot a szervernek hogy szeretnénk használni
	//parts[0] section
	//parts[1] slot
	mp.trigger("client:UseItemToServer", parseInt(parts[0]),parseInt(parts[1]) );
  };
		  } else if (current_itemType == item.id) {//nem szabad a hely, megnézzük hogy ugyanolyan item van-e ott mint nekünk kell
		  console.log(item.lastElementChild.innerHTML);
			item.lastElementChild.innerHTML -= amount;
			if (parseInt(item.lastElementChild.innerHTML) < 1) {
			  ghostItem.remove();
			  status_click = false;
			  item.remove();
			}
			let destiny = parseInt(
			  area.firstElementChild.lastElementChild.innerHTML
			);
			area.firstElementChild.lastElementChild.innerHTML = parseInt(destiny) + parseInt(amount);
			console.log('itemmove-8');//két item egybe húzása
		  }
		}
		item && item.classList.remove('invisible');
		ghostItem.remove();
		status_click = false;
	  };

	  status_click = !status_click;

	  if (status_click) {
		moveAt(event.pageX, event.pageY);
	  }

	  function moveAt(pageX, pageY) {
		ghostItem.style.left = pageX - shiftX + 'px';
		ghostItem.style.top = pageY - shiftY + 'px';
	  }

	  function onMouseMove(event) {
		if (status_click) {
		  moveAt(event.pageX, event.pageY);
		}
		ghostItem.hidden = true;
		let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
		
		ghostItem.hidden = false;
		
		if (!elemBelow) return;
		let droppableBelow = elemBelow.closest('.slot');
		
		if (current_slot != droppableBelow) {
		  if (current_slot) {
			leaveDroppable(current_slot);
		  }
		  current_slot = droppableBelow;
		  if (current_slot) {
			enterDroppable(current_slot);
		  }
		}
	  }

	  document.addEventListener('mousemove', onMouseMove);
	  
	  }
	}
}


function enterDroppable(elem) {
  current_itemId = elem.id;
  if (elem.firstElementChild) {
    current_itemType = elem.firstElementChild.id;
    child = elem.firstElementChild;
    current_itemValue = child.lastElementChild.innerHTML;
  }
}

function leaveDroppable(elem) {
  current_itemId = null;
  current_itemType = null;
  current_itemValue = null;
  free_space = false;
}





function clearInventory()
{
	items.forEach((item) => {
	 item.remove();
	});
}


function itemActive(section,slot,state){
if(state == 1){
let activeitem = document.getElementById(section+';'+slot);
activeitem.style.border = 'solid 2px green';
activeitem.isactive = true;
}
else
{
let activeitem = document.getElementById(section+';'+slot);
activeitem.isactive = false;
activeitem.style.border = 'solid 2px grey';
activeitem.style.border.hover = 'solid 2px orange';
}


}

function loadInventory()
{
	items = document.querySelectorAll('.item');
	
	items.forEach((item) => {
	  item.addEventListener('mousedown', moveItem);
	  item.addEventListener('contextmenu', moveItem);
	  item.setAttribute('draggable', false);
	  item.isactive = false;
	    item.oncontextmenu = function (event) {
    event.preventDefault();
    let parts = item.parentNode.id.split(";");//a slot ID-je kell nekünk majd és átküldeni a section/slot-ot a szervernek hogy szeretnénk használni
	//parts[0] section
	//parts[1] slot
	mp.trigger("client:UseItemToServer", parseInt(parts[0]),parseInt(parts[1]) );
  };
  
  
	});
}


function addNewItem(section,slot,itemid,itemname,itemdescription,weight,amount,itempicture)
{
let addedSlot = document.getElementById(section+';'+slot);
	let toAdd = '<div class="item" id="' + itemid + '">' +
              '<img ' +
                'src="'+itempicture+'"'+
              '/>' +
              '<div class="quantity">'+ amount +
              '</div>'+
				'<div class="weight">'+ (weight*amount)/1000 + ' kg</div>' +
				'<div class="name">'+ itemname +
              '</div>'+
            '</div>';
	addedSlot.innerHTML = toAdd;
	let addedItem = addedSlot.firstChild;
	addedItem.section = section;
	addedItem.itemslot = slot;
	addedItem.itemid = itemid;
	addedItem.itemname = itemname;
	addedItem.itemdescription = itemdescription;
	addedItem.amount = amount;
	addedItem.weight = weight;
	addedItem.totalweight = weight*amount;
	addedItem.addEventListener('mouseenter', displayItemInfo);
    addedItem.addEventListener('mouseleave', hideToolTip);
//ha már van a sloton valami item akkor nem egyezik a szerver-kliens inv -> újratölteni
}

function deleteItem()
{

//ha nem sikerült törölni akkor újratölteni az egészet, mert nem egyezik
}


function itemMoveToServer(beginSlot, endSlot, amount){
//átküldeni a szervernek az item move-ot
//ha nem egyezik valami akkor reloadInventory -> egész kliens oldal újratöltése szerver alapján
}

function useItemToServer(slot){
//átküldeni a szervernek hogy melyik sloton lévő itemet szeretnénk használni
//ha nem egyezik valami akkor reloadInventory -> egész kliens oldal újratöltése szerver alapján
}
tooltip.style.display = 'none';
    </script>
</html>