<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css" type="text/css" />
</head>
<body>
<div class="content">
      <div class="interactions">
        <div class="interaction" id="giveitem"><p>Átadás</p></div>
        <div class="interaction" id="useitem"><p>Használat</p></div>
        <div class="interaction" id="showitem"><p>Felmutatás</p></div>
        <div class="interaction" id="renameitem"><p>Átnevezés</p></div>
        <div class="interaction" id="dropitem"><p>Eldobás</p></div>
      </div>
      <div class="inventory player">
        <div class="header">
          <div id="playername" class="headertext">Karakter neve</div>
          
          <input id="inventory-search" type="text" class="search" placeholder="Keresés...">

        </div>
        <div class="inventory-items">
        </div>
      </div>

      <div class="inventory container invisible">
        <div class="header">
          <div id="containertext" class="headertext">Tároló</div>
          <input id="container-search" type="text" class="search" placeholder="Keresés...">

        </div>
        <div class="container-items">
        </div>

      </div>

      <div class="clothes">
        <div class="slot" id="kalap"></div>
        <div class="slot" id="nyaklanc"></div>
        <div class="slot" id="polo"></div>
        <div class="slot" id="kesztyu"></div>
        <div class="slot" id="nadrag"></div>
        <div class="slot" id="cipo"></div>
        <div class="slot" id="taska"></div>

        <div class="slot" id="maszk"></div>
        <div class="slot" id="szemuveg"></div>
        <div class="slot" id="fulbevalo"></div>
        <div class="slot" id="karkoto"></div>
        <div class="slot" id="ora"></div>
        <div class="slot" id="kituzo"></div>
        <div class="slot" id="armor"></div>
      </div>

      <div class="actionbar">
        <div class="action_slot"><div class="action_number">0</div></div>
        <div class="action_slot"><div class="action_number">1</div></div>
        <div class="action_slot"><div class="action_number">2</div></div>
        <div class="action_slot"><div class="action_number">3</div></div>
        <div class="action_slot"><div class="action_number">4</div></div>
        <div class="action_slot"><div class="action_number">5</div></div>
        <div class="action_slot"><div class="action_number">6</div></div>
        <div class="action_slot"><div class="action_number">7</div></div>
        <div class="action_slot"><div class="action_number">8</div></div>
        <div class="action_slot"><div class="action_number">9</div></div>
      </div>

    </div>

    <div class="givemenu">
      <div class="close">X</div>
      <div class="title"><h1>TÁRGY ÁTADÁSA</h1></div>
      <div class="itemname">placeholder</div>
      <input id="amount" type="range" class="amount" name="points" step="1" min="1" max="10" value="1">
      <label id="amount-label" for="amount" class="amountnumber">1</label>
      <div class="nearbyplayers">
      </div>
    </div>

    <div class="itemmenu">
      <div class="menubutton" id="use_item">Használat</div>
      <div class="menubutton">Szétválasztás</div>
      <div class="menubutton" id="close_menu">Mégse</div>

    </div>

    <div class="tooltip">
      <div class="name">Neve</div>
      <hr>
      <div class="description">valami jó hosszú leírás</div>
      <div class="weight">2 kg</div>
    </div>
    </body>
	<script>


    var givemenu = document.querySelector('.givemenu');
    var givemenu_slider = document.querySelector('.amount');
    var givemenu_itemname = document.querySelector('.itemname');
    var nearbyplayers =  document.querySelector('.nearbyplayers');
    var selected_player = null;
    var givemenu_name = null;
    var givemenu_itemid = null;
    var givemenu_maxvalue = null;

    var items = document.querySelectorAll('.item');
    var container = document.querySelector('.container');
    var inv_player = document.querySelector('.inventory-items');
    var inv_container = document.querySelector('.container-items');
    var inv_clothes = document.querySelectorAll('.slot');

    var amount_slider = document.querySelector('.amount');
    var amount_number = document.querySelector('.amountnumber');
    amount_slider.addEventListener('input',UpdateSlider);

    var closegivemenu = document.querySelector('.close');

    var nearbyplayers = document.querySelector('.nearbyplayers');
    closegivemenu.addEventListener('mousedown', closeGiveMenu);

    var inventory_title = document.querySelector('#playername');
    var container_title = document.querySelector('#containertext');


    var item = null;

    var itemmenu = document.querySelector('.itemmenu');
    var split_item = null;
    var close_itemmenu = null;
    var use_itemmenu = null;
    var open_container = null;
    var target_itemmenu = null;

    var tooltip = document.querySelector('.tooltip');
    var status_click = false;
    var ghostItem = null;
    var target_inventory = null;
    var target_interact = null;
    var target_container = null;
    var target_item = null;
    var target_slot = null;

    function setInventoryName(theName)
    {
      inventory_title.innerHTML = theName;
    }

    function setContainerName(theName)
    {
      container_title.innerHTML = theName;
    }

    function UpdateSlider(source){
      amount_number.innerHTML = amount_slider.value;
    }

    function SetSliderMax(value)
    {
      givemenu_slider.max = value;
      givemenu_slider.value = 1;
      UpdateSlider();
    }

    function AddNameToGivemenu(name, playerid)
    {
      let toAdd = document.createElement('input');
      toAdd.className = 'playerselect';
      toAdd.type = 'button';
      toAdd.value = name;
      toAdd.id = playerid;
      toAdd.addEventListener('click',selectPlayer);
      nearbyplayers.appendChild(toAdd);
    }

    function selectPlayer(ev)
    {
      selected_player = ev.target.id;
      //console.log(selected_player + ' item: ' + givemenu_itemid + ' amount: ' + givemenu_slider.value);
      //beállítjuk a kiszemelt játékos ID-jét
      //átküldjük szerver oldalra hogy melyik itemet (adatbázis id) szeretnénk átadni, melyik playernek és hány darabot. Ha az összeset akkor csak átrakjuk, ha nem akkor új itemet hozunk létre és állítjuk az értékeket megfelelően
      mp.trigger('client:GiveItem',givemenu_itemid,selected_player,givemenu_slider.value);
      closeGiveMenu();
    }

    function clearGiveMenu()
    {
      let playernames = document.querySelectorAll('.playerselect');
      playernames.forEach(removenames);
      function removenames(name){
        name.remove();
      }
      
    }


  
    function closeGiveMenu()
    {
      clearGiveMenu();
      givemenu.style.display = 'none';
      givemenu_slider.value = 0;
      givemenu_slider.max = 0;
      selected_player = -1;
      givemenu_itemid = -1;
    }

    function openGiveMenu()
    {
      givemenu.style.display = 'block';
      givemenu_itemname.innerHTML = givemenu_name;
      givemenu_slider.value = 1;
      givemenu_slider.max = givemenu_maxvalue;
    }

    function addItemToInventory(dbid,itemid, itemname, itemdescription, weight, amount, itempicture, priority, inuse, itemtype){
      RemoveItem(dbid);
      let newItem =  document.createElement('div');
      newItem.className = 'item';
      newItem.id = dbid;
      newItem.innerHTML = '<img src="'+itempicture+'"></img>'+
            '<div class="name">'+itemname+'</div>'+
              '<div class="amount">'+amount+'</div>'+
              '<div class="weight">'+(amount*weight)/1000+' kg</div>'+
              '<div class="colorcode">'+''+'</div>';
      let color = GetColorByItemType(itemtype);

      let cc = newItem.querySelector('.colorcode');
      cc.style.backgroundColor = color;
      newItem.itemid = itemid;
      newItem.itemname = itemname;
      newItem.itemdescription = itemdescription;
      newItem.weight = weight;
      newItem.priority = priority;
      newItem.amount = amount;
      if (inuse === 'True')
      {
        newItem.inuse = true;
      }
      else{
        newItem.inuse = false;
      }

      if(newItem.inuse == true)
      {
        newItem.style.outline = 'solid 1px #02c39a';
      }

      newItem.classList.add('invisible');
      inv_player.appendChild(newItem);

      newItem.addEventListener('mouseenter', displayItemInfo);
      newItem.addEventListener('mouseleave', hideToolTip)
      newItem.addEventListener('contextmenu', useItem);
      newItem.addEventListener('mousedown', moveItem);
      sortItems();
      newItem.classList.remove('invisible');
    }

    function ClearContainer(){
      items = inv_container.querySelectorAll('.item');
      items.forEach(remove_every_item);

      function remove_every_item(item){
          item.remove();
      }
    }

    function ShowContainer()
    {
      container.classList.remove('invisible');
    }

    function HideContainer()
    {
      ClearContainer();
      container.classList.add('invisible');
    }

    function GetColorByItemType(theType)
    {
      switch(theType)
      {
        case '0':
        return 'rgba(0,0,0,0)';
        break;
        case '1':
          return '#247ba0';
        break;
        case '2':
          return '#ffe066';
        break;
        case '3':
          return '#f25f5c';
        break;
        case '4':
          return '#f77e7c';
        break;
        case '5':
          return '#1b98e0';
        break;
        case '6':
          return '#1a936f';
        break;
        case '7':
          return '#ffa686';
        break;
        case '8':
          return '#513b56';
        break;
        case '9':
          return '#f3ffbd';
        break;
        default:
          return 'red';
          break;
      }
    }

    function addItemToContainer(dbid,itemid, itemname, itemdescription, weight, amount, itempicture, priority, inuse, itemtype){
      RemoveItem(dbid);
      let newItem =  document.createElement('div');
      newItem.className = 'item';
      newItem.id = dbid;
      newItem.innerHTML = '<img src="'+itempicture+'"></img>'+
            '<div class="name">'+itemname+'</div>'+
              '<div class="amount">'+amount+'</div>'+
              '<div class="weight">'+(amount*weight)/1000+' kg</div>'+
              '<div class="colorcode">'+''+'</div>';
      let color = GetColorByItemType(itemtype);

      let cc = newItem.querySelector('.colorcode');
      cc.style.backgroundColor = color;

      newItem.itemid = itemid;
      newItem.itemname = itemname;
      newItem.itemdescription = itemdescription;
      newItem.weight = weight;
      newItem.priority = priority;
      newItem.amount = amount;
      if (inuse === 'True')
      {
        newItem.inuse = true;
      }
      else{
        newItem.inuse = false;
      }

      newItem.classList.add('invisible');
      inv_container.appendChild(newItem);
      
      newItem.addEventListener('mouseenter', displayItemInfo);
      newItem.addEventListener('mouseleave', hideToolTip)
      newItem.addEventListener('contextmenu', useItem);
      newItem.addEventListener('mousedown', moveItem);
      sortItems();
      newItem.classList.remove('invisible');
    }

    function addItemToSlot(dbid,itemid, itemname, itemdescription, weight, amount, itempicture, priority){
      RemoveItem(dbid);
      let newItem =  document.createElement('div');
      newItem.className = 'item';
      newItem.id = dbid;
      newItem.innerHTML = '<img src="'+itempicture+'"></img>';

      newItem.itemid = itemid;
      newItem.itemname = itemname;
      newItem.itemdescription = itemdescription;
      newItem.weight = weight;
      newItem.priority = priority;
      newItem.inuse = Boolean(true);

      let toAppend = null;
      switch(itemid)
      {
          case '1':
            toAppend = document.querySelector("#kalap");
            break;
          case '2':
            toAppend = document.querySelector("#maszk");
            break;
          case '3':
            toAppend = document.querySelector("#nyaklanc");
            break;
          case '4':
            toAppend = document.querySelector("#szemuveg");
            break;
          case '5':
            toAppend = document.querySelector("#polo");
            break;
          case '6':
            toAppend = document.querySelector("#fulbevalo");
            break;
          case '7':
          toAppend = document.querySelector("#nadrag");
            break;
          case '8':
            toAppend = document.querySelector("#karkoto");
            break;
          case '9':
          toAppend = document.querySelector("#cipo");
            break;
          case '10':
            toAppend = document.querySelector("#ora");
            break;
          case '11':
          toAppend = document.querySelector("#taska");
            break;
          case '12':
          toAppend = document.querySelector("#armor");
            break;
            case '13':
          toAppend = document.querySelector("#kituzo");
          case '14':
            toAppend = document.querySelector("#kalap");
            break;
          case '15':
            toAppend = document.querySelector("#maszk");
            break;
          case '16':
            toAppend = document.querySelector("#nyaklanc");
            break;
          case '17':
            toAppend = document.querySelector("#szemuveg");
            break;
          case '18':
            toAppend = document.querySelector("#polo");
            break;
          case '19':
            toAppend = document.querySelector("#fulbevalo");
            break;
          case '20':
          toAppend = document.querySelector("#nadrag");
            break;
          case '21':
            toAppend = document.querySelector("#karkoto");
            break;
          case '22':
          toAppend = document.querySelector("#cipo");
            break;
          case '23':
            toAppend = document.querySelector("#ora");
            break;
          case '24':
          toAppend = document.querySelector("#taska");
            break;
          case '25':
          toAppend = document.querySelector("#armor");
            break;
          case '26':
          toAppend = document.querySelector("#kituzo");
            break;
          case '27':
            toAppend = document.querySelector("#kesztyu");
            break;
          default:
            console.log('invalid slot');
            break;
      }
      if(toAppend != null)
      {
        toAppend.appendChild(newItem);
      }

      newItem.addEventListener('mouseenter', displayItemInfo);
      newItem.addEventListener('mouseleave', hideToolTip)
      newItem.addEventListener('contextmenu', useItem);
      newItem.addEventListener('mousedown', moveItem);
    }

  function itemMenu(ev){
    ev.preventDefault();
    const item = this;
    itemmenu.style.display = 'block';
    var rect = item.getBoundingClientRect();
    itemmenu.style.left = (rect.left+rect.right) /2 + 'px';
    itemmenu.style.top = rect.bottom-5 + 'px';
    
    target_itemmenu = item;
    setItemMenuStyle(item);
  }


  function setItemMenuStyle(item)
  {
    itemmenu.innerHTML = '';

    if(target_itemmenu.itemid <= 14 && target_itemmenu.inuse == true)//ruha
    {
      itemmenu.innerHTML += '<div class="menubutton" id="use_item">Levétel</div>';
    }
    else if(target_itemmenu.itemid <= 14)//ruha
    {
      itemmenu.innerHTML += '<div class="menubutton" id="use_item">Felvétel</div>';
    }

    if(target_itemmenu.itemid == 18 && target_itemmenu.inuse == true)//pisztoly
    {
      itemmenu.innerHTML += '<div class="menubutton" id="use_item">Elrakás</div>';
    }
    else if(target_itemmenu.itemid == 18 || target_itemmenu.itemid == 20)
    {
      itemmenu.innerHTML += '<div class="menubutton" id="use_item">Elővétel</div>';
    }

/*
    if(item.container > 0)//tároló
    {
      itemmenu.innerHTML += '<div class="menubutton" id="open_container">Megnyitás</div>';
    }
*/

    if(item.amount > 1)
    {
      itemmenu.innerHTML += '<div class="menubutton" id="split_item">Szétválasztás</div>';
    }
    itemmenu.innerHTML += '<div class="menubutton" id="close_menu">Mégse</div>';
    close_itemmenu = document.querySelector('#close_menu');
    close_itemmenu.addEventListener('mousedown', closeItemMenu);

    use_itemmenu = document.querySelector('#use_item');
    if(use_itemmenu != null)
    {
      use_itemmenu.addEventListener('mousedown',useItem);
    }

    open_container = document.querySelector('#open_container');
    if(open_container != null)
    {
      open_container.addEventListener('mousedown',openContainer);
    }
      
    split_item = document.querySelector('#split_item');
    if(split_item != null)
    {
      split_item.addEventListener('mousedown', splitItem);
    }
      
  }

  function splitItem(ev)
  {
    console.log('Szétválaszt: '+target_itemmenu);
  }

  function openContainer(ev)
  {
    mp.trigger('client:OpenContainer',item.id);
    closeItemMenu(ev);
  }

  function useItem(ev){
    ev.preventDefault();
    if(status_click === false)
    {
      const item = this;
      mp.trigger('client:UseItem',item.id);
      hideToolTip();
      /*
      EZT MÁR ÁTÍRTUK SZERVER OLDALI KEZELÉSRE
      if(item.itemid <= 14 && item.inuse == true)//ruha item és viselve van
      {
        mp.trigger('client:MoveItem',item.id, 0);
      }
      else if(item.itemid <= 14)//ruha item és nincs használatban
      {
        mp.trigger('client:MoveItemToClothing',item.id,-1);
      }
      else
      {
        
      }
   */
  }
}

  function setItemUse(dbid, state)
  {
      var toSet = document.getElementById(String(dbid));
      if (state === 'True')
      {
        toSet.inuse = true;
      }
      else{
        toSet.inuse = false;
      }
  }

  function closeItemMenu(ev){
    ev.preventDefault();
    itemmenu.style.display = 'none';
  }


  function setItemPrio(dbid, prio)
    {
      var toSet = document.getElementById(String(dbid));
      toSet.priority = parseInt(prio);
    }

  function sortItems()
  {
    items = inv_player.querySelectorAll('.item');
    var listitems = [];
    items.forEach((userItem) => {
      listitems.push(userItem);
    })

    listitems.sort(function(a,b)
    {
      var compA = parseInt(a.priority);
      var compB = parseInt(b.priority);
      return (compA < compB) ? - 1 : (compA > compB) ? 1 : 0;
    }
    );

    for(i = 0; i < listitems.length; i++)
    {
      inv_player.appendChild(listitems[i]);
    }
  }

  function moveItem(ev){
    
    if(event.button == 0 && !status_click && (this.inuse === false || this.parentElement.classList.contains('slot')))//bal klikk ÉS (nincs használatban VAGY felvett ruha))
    {
      ev.preventDefault();
      item = this;
      ghostItem = item.cloneNode(true);
      ghostItem.style.border = '0';
      let ghostItemName = ghostItem.querySelector('.name');
      if(ghostItemName != null)
      {
        ghostItemName.style.visibility = 'hidden';
      }
      
      let ghostItemAmount = ghostItem.querySelector('.amount');
      if(ghostItemAmount != null)
      {
        ghostItemAmount.style.visibility = 'hidden';
      }

      let ghostItemWeight = ghostItem.querySelector('.weight');
      if(ghostItemWeight != null)
      {
        ghostItemWeight.style.visibility = 'hidden';
      }

      ghostItem.setAttribute('class', 'ghostItem');
      item.classList.add('invisible');

      let shiftX = ghostItem.getBoundingClientRect().left + 20;
      let shiftY = ghostItem.getBoundingClientRect().top + 20;

      ghostItem.style.position = 'absolute';
      ghostItem.style.zIndex = 1000;
      document.body.append(ghostItem);

      status_click = true;

      if(status_click){
        moveAt(event.pageX,event.pageY);
      }
      
      function moveAt(pageX, pageY) {
        ghostItem.style.left = pageX - shiftX + 'px';
        ghostItem.style.top = pageY - shiftY + 'px';
	  }


    function onMouseMove(event) {
      if (status_click) {
        moveAt(event.pageX, event.pageY);
      }
      ghostItem.hidden = true;
      let elemBelow = document.elementFromPoint(event.clientX, event.clientY);
      
      ghostItem.hidden = false;
      if (!elemBelow) return;
      target_inventory = elemBelow.closest('.inventory-items');
      target_interact = elemBelow.closest('.interaction');
      target_container = elemBelow.closest('.container-items');
      let itemBelow = elemBelow.closest('.item');
      let clothingBelow = elemBelow.closest('.slot');
      target_item = itemBelow;
      target_slot = clothingBelow;
	  }

      document.addEventListener('mousemove', onMouseMove);
      ghostItem.addEventListener('mouseup', dropItem);
    }

  function dropItem(ev)//megnézni hogy az inventory vagy container fölött engedte-e el.
  {//ha inventory, akkor -> priority változtatás - item sorbarendezés
    //ha container, akkor küldeni szervernek, visszakapni hogy törölje az inventorynkból és hozzáadja a másikhoz
    if(target_slot != null && target_slot)//ruha slot-ra húzta
    {
      let target_clothing = -1;
      switch(target_slot.id)
      {
          case 'kalap':
            target_clothing = 0;
            break;
          case 'maszk':
            target_clothing = 1;
            break;
          case 'nyaklanc':
            target_clothing = 2;
            break;
          case 'szemuveg':
            target_clothing = 3;
            break;
          case 'polo':
            target_clothing = 4;
            break;
          case 'fulbevalo':
            target_clothing = 5;
            break;
          case 'nadrag':
            target_clothing = 6;
            break;
          case 'karkoto':
            target_clothing = 7;
            break;
          case 'cipo':
            target_clothing = 8;
            break;
          case 'ora':
            target_clothing = 9;
            break;
          case 'taska':
            target_clothing = 10;
            break;
          case 'armor':
            target_clothing = 11;
            break;
          case 'kituzo':
            target_clothing = 12;
            break;
          case 'kesztyu':
            target_clothing = 13;
            break;
 
          default:
            console.log('invalid slot');
            break;
      }
      if(target_clothing != -1)//valid slotra húzta, átadhatjuk
      {
        mp.trigger('client:MoveItemToClothing',item.id,target_clothing);
        //console.log(target_clothing);
      }
      
    }
    else if(target_item != null)//item-re húzta, inventory is beállítva ilyenkor
    {
      //console.log(item.id + '->'+target_item.id);
      mp.trigger('client:SwapItem',item.id,target_item.id);
    }
    else if(target_inventory == inv_player)//saját inventory-jába húzta
    {
      mp.trigger('client:MoveItem',item.id, 0);
    }
    else if(target_container == inv_container)//tárolóba húzta utolsó helyre
    {
      mp.trigger('client:MoveItem',item.id, 1);
    }
    else if(target_interact)//ráhúzta valami interact-ra
    {
      switch(target_interact.id)
      {
        case 'giveitem'://átadás menü
        givemenu_name = item.itemname;
        givemenu_itemid = item.id;
        givemenu_maxvalue = item.amount;
        mp.trigger('client:GiveItemMenu');
          break;
        case 'useitem'://használat
          mp.trigger('client:UseItem',item.id);
          break;
        case 'showitem'://felmutatás
          break;
        case 'renameitem'://átadás menü
          break;
        case 'dropitem'://eldobás
          mp.trigger('client:DropItem',item.id);
          break;
      }
    }
    else//nem húzta semmire
    {
      console.log('nem húzta semmire');
    }
      ghostItem.remove();
      item.classList.remove('invisible');
      item = null;
      status_click = false;
  }
}
//MOVEITEM VÉGE

    function RemoveItem(dbid){
      items = document.querySelectorAll('.item');
      items.forEach(remove_one_item);
      function remove_one_item(item){
        if(item.id == ''+dbid){
          item.remove();
        }
      }
    }

    function ClearInventory(){
      items = document.querySelectorAll('.item');
      items.forEach(remove_every_item);

      function remove_every_item(item){
          item.remove();

      }
    }

    function displayItemInfo(event){
      if(status_click === false)//nem mozgat egy itemet sem
      {
          item = this;

          let displayinfoitem = event.target;
          let name = displayinfoitem.itemname;
          let description = displayinfoitem.itemdescription;
          let weight = displayinfoitem.weight;
          let unit = 'gramm';

          if (weight > 1000)
          {
            weight = weight / 1000;
            unit = 'kilogramm';
          }
          let toDisplay = '';
          if (description != '')
          {
            toDisplay = name+'<br/><hr>'+ description+'<br/>Súly: '+ weight+' ' + unit;
          }
          else
          {
            toDisplay = name+'<br/><hr>Súly: '+ displayinfoitem.weight+' '+unit;
          }

          toDisplay += '<br/>Prio:'+displayinfoitem.priority;
          
          tooltip.innerHTML = toDisplay;
          tooltip.style.display = 'block';
          document.addEventListener('mousemove', moveToolTip);
      }



	  }

    function moveToolTip(event) {
      let x = event.clientX;
      let y = event.clientY;
      tooltip.style.left = x+2 + 'px';
      tooltip.style.top = y+2 + 'px';
    }

  function hideToolTip(){

		  tooltip.style.display = 'none';
		  document.removeEventListener('mousemove', moveToolTip);

      /*
      if(item.inuse == true && !item.parentElement.classList.contains('slot'))//használatban van és nem ruha
      {
        item.style.border = 'solid 0.2vh orange';
      }
      else if(item.parentElement.classList.contains('slot'))//nincs használtban és ruha
      {
        item.style.border = '0';
      }
      else//nincs használatban és nem is ruha
      {
        item.style.border = 'solid 0.2vh black';
      }
      */
	}

  

    </script>
</html>